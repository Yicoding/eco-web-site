---
toc: menu
---

# 小程序双线程架构

## 1.什么是双线程模式

![image](images/frame/19.png)

- 1.小程序的渲染层和逻辑层分别由 2 个线程管理：

  - 渲染层：界面渲染相关的任务全都在 WebView 里执行。一个小程序存在多个界面，所以渲染层存在多个 WebView 线程

  - 逻辑层：采用 JsCore 线程运行 JS 脚本

- 2.视图层和逻辑层通过系统层的 `WeixinJsBridge` 进行通信：逻辑层把数据变化通知到视图层，触发视图层页面更新，视图层把触发的事件通知到逻辑层进行业务处理

- 3.页面渲染的具体流程是:

  - 在渲染层，宿主环境会把 WXML 转化成对应的 JS 对象，在逻辑层发生数据变更的时候，我们需要通过宿主环境提供的 setData 方法把数据从逻辑层传递到渲染层，再经过对比前后差异，把差异应用在原来的 DOM 树上，渲染出正确的 UI 界面

## 2.web 页面开发有几个问题

### 1）体验

- 用户在访问网页的时候，在浏览器开始显示之前都会有一个白屏的过程，受限于设备性能和网络速度，白屏会更加明显。为了解决体验问题，微信推出“微信 Web 资源离线存储”，类似 HTML5 的 Application Cache，能解决部分白屏问题，但是 web 的体验上还是和原生有着很大落差，例如页面的切换，页面加载条等。

### 2）管控

- web 页面自由度很高，需要花很大的人力去检查页面是否存在违规等操作

## 3.小程序优势

### 1）体验

- web 页面开发渲染线程和脚本线程是互斥的，长时间的脚本运行可能会导致页面失去响应或者白屏。而双线程模式是不会有这个问题的。而且这个模式下，强制使用了 MVVM 框架的数据驱动，即让视图状态和视图绑定在一起，同时也使用了虚拟 dom 优化体验

### 2）管控

- 阻止开发者使用浏览器的开发性接口，通过提供一个沙盒环境来运行开发者的 js 代码，只能使用微信提供开放的方法来获取元素的一些信息。这样就避免开发者的操作不在管控范围。除了 JS 用沙盒环境管控，html 也改用了封装过的 wxml(WeiXin Markup language) ，css 改为 wxss(WeiXin Style Sheet)，为了管控，同时也是为了提供更多功能，例如封装了播放直播的 live-player、滚动选择器 picker-view。另外，也提供了 wxs(WeiXin Script)让 wxml 在渲染的时候也可以做一些逻辑处理

## 4.双线程模型缺点

- 带来了无处不在的异步问题（任何数据传递都是线程间的通信，也就是都会有一定的延时），不过小程序在框架层面已经封装好了异步带来的时序问题

## 5.实现原理

- 小程序是基于 WEB 规范封装的一套 Hybrid 框架

- 小程序的渲染层和逻辑层是用多个 webview 实现的

- 逻辑层的 JS 代码全部载入到一个 Webview 里面，称之为 AppService

- 整个小程序仅仅有一个，而且整个生命周期常驻内存

- 而全部的视图（wxml 和 wxss）都是单独的 Webview 来承载，称之为 AppView
