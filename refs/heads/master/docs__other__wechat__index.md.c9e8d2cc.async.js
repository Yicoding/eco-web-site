(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[171],{JjdP:function(e,n,t){"use strict";t.r(n),n["default"]={}},Zs1V:function(e){e.exports=JSON.parse("{}")},onnj:function(e,n,t){"use strict";t.r(n);var a=t("q1tI"),r=t.n(a),c=t("dEAq"),o=t("H1Ra");t("JjdP");n["default"]=e=>(r.a.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&c["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"markdown"},r.a.createElement("h1",{id:"\u5fae\u4fe1\u516c\u4f17\u53f7\u5f00\u53d1"},r.a.createElement(c["AnchorLink"],{to:"#\u5fae\u4fe1\u516c\u4f17\u53f7\u5f00\u53d1","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"\u5fae\u4fe1\u516c\u4f17\u53f7\u5f00\u53d1"),r.a.createElement("ul",null,r.a.createElement("li",null,"\u670d\u52a1\u53f7")),r.a.createElement("h2",{id:"1\u542f\u7528\u670d\u52a1\u5668\u914d\u7f6e"},r.a.createElement(c["AnchorLink"],{to:"#1\u542f\u7528\u670d\u52a1\u5668\u914d\u7f6e","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"1.\u542f\u7528\u670d\u52a1\u5668\u914d\u7f6e"),r.a.createElement("ul",null,r.a.createElement("li",null,r.a.createElement("p",null,"1.\u914d\u7f6e\u670d\u52a1\u5668\u5730\u5740(URL)")),r.a.createElement("li",null,r.a.createElement("p",null,"2.\u8bbe\u7f6e\u4ee4\u724c(Token)")),r.a.createElement("li",null,r.a.createElement("p",null,"3.\u6d88\u606f\u52a0\u89e3\u5bc6\u5bc6\u94a5\uff08\u53ef\u968f\u673a\u751f\u6210\uff09"))),r.a.createElement("h2",{id:"2\u76d1\u542c\u7528\u6237\u5728\u516c\u4f17\u53f7\u5185\u7684\u64cd\u4f5c"},r.a.createElement(c["AnchorLink"],{to:"#2\u76d1\u542c\u7528\u6237\u5728\u516c\u4f17\u53f7\u5185\u7684\u64cd\u4f5c","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"2.\u76d1\u542c\u7528\u6237\u5728\u516c\u4f17\u53f7\u5185\u7684\u64cd\u4f5c"),r.a.createElement(o["a"],{code:"var xml2js = require('xml2js');\nconst { parseString } = xml2js;\n\n// \u89e3\u6790xml\nfunction parseXml(xml) {\n  return new Promise((resolve, reject) => {\n    parseString(xml, function (err, result) {\n      console.dir(result);\n      if (err) {\n        return reject(err);\n      }\n      resolve(result?.xml);\n    });\n  });\n}\n\n// \u76d1\u542cpost\nasync function getconfigPost(ctx) {\n  try {\n    const xml = ctx.request.body;\n    const result = await parseXml(xml);\n    if (result.MsgType[0] === 'event') {\n      if (result.Event[0] === 'subscribe') {\n        // \u5173\u6ce8\u5fae\u4fe1\u516c\u4f17\u53f7\n        const res = await getUserUnionIDFunc(result.FromUserName[0]);\n        // \u5c06\u7528\u6237\u6570\u636e\u6dfb\u52a0\u5230openid\u548cunionid\u5bf9\u53f7\u8868\u4e2d\n        await addRelationFunc(res);\n      } else if (result.Event[0] === 'unsubscribe') {\n        // \u53d6\u5173\n        unsubscribeClientUser(result.FromUserName[0]);\n      }\n    }\n    ctx.state.code = 0;\n    ctx.body = `<xml><ToUserName><![CDATA[${\n      result.FromUserName[0]\n    }]]></ToUserName><FromUserName><![CDATA[${\n      result.ToUserName[0]\n    }]]></FromUserName><CreateTime>${Date.now()}</CreateTime><MsgType><![CDATA[text]]></MsgType><Content><![CDATA[\u4f60\u597d]]></Content></xml>`;\n  } catch (err) {\n    ctx.state.code = -1;\n    throw new Error(err);\n  }\n}",lang:"js"}),r.a.createElement("h2",{id:"3\u81ea\u5b9a\u4e49\u83dc\u5355"},r.a.createElement(c["AnchorLink"],{to:"#3\u81ea\u5b9a\u4e49\u83dc\u5355","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"3.\u81ea\u5b9a\u4e49\u83dc\u5355"),r.a.createElement(o["a"],{code:"// \u521b\u5efa\u83dc\u5355\nasync function createMenu(ctx) {\n  try {\n    const access_token = await readAccessTokenWeixin(); // \u8bfb\u53d6token\n    const url = `https://api.weixin.qq.com/cgi-bin/menu/create?access_token=${access_token}`;\n    const values = {\n      button: [\n        {\n          type: 'miniprogram',\n          name: 'name',\n          url: 'https://xxx.com',\n          appid: 'xxx',\n          pagepath: 'pages/index/index',\n        },\n        {\n          type: 'miniprogram',\n          name: 'name2',\n          url: 'https://xxx.com',\n          appid: 'xxx',\n          pagepath: 'pages/home/index',\n        },\n      ],\n    };\n    const res = await axios.post(url, values);\n    ctx.state.code = 0;\n    ctx.state.data = res.data;\n  } catch (err) {\n    ctx.state.code = -1;\n    throw new Error(err);\n  }\n}",lang:"js"}),r.a.createElement("h2",{id:"4\u6839\u636e-openid-\u83b7\u53d6-unionid"},r.a.createElement(c["AnchorLink"],{to:"#4\u6839\u636e-openid-\u83b7\u53d6-unionid","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"4.\u6839\u636e openid \u83b7\u53d6 UnionID"),r.a.createElement(o["a"],{code:"function getUserUnionIDFunc(openid) {\n  return new Promise(async (resolve, reject) => {\n    try {\n      const access_token = await readAccessTokenWeixin();\n      const url = 'https://api.weixin.qq.com/cgi-bin/user/info';\n      const values = { access_token, openid };\n      const { data } = await axios.get(url, { params: values });\n      resolve(data);\n    } catch (err) {\n      reject(err);\n    }\n  });\n}",lang:"js"}),r.a.createElement("h2",{id:"5\u6a21\u677f\u6d88\u606f"},r.a.createElement(c["AnchorLink"],{to:"#5\u6a21\u677f\u6d88\u606f","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"5.\u6a21\u677f\u6d88\u606f"),r.a.createElement(o["a"],{code:"function templateSend(values) {\n  return new Promise(async (resolve, reject) => {\n    try {\n      const access_token = await readAccessTokenWeixin();\n      const url = `https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=${access_token}`;\n      const { data } = await axios.post(url, values);\n      console.log('templateSend', data);\n      resolve(data);\n    } catch (err) {\n      reject(err);\n    }\n  });\n}\n\n// \u8ba2\u5355\u901a\u77e5\nasync function sendOrderTemplate(ctx) {\n  try {\n    const { openid, amount, order_id, user_info, store_id } = ctx.request.body; // type: 1 \u5ba1\u6838\u901a\u8fc7  2 \u5ba1\u6838\u9a73\u56de\n    const currentTime = changedate(new Date(), 'yyyy-MM-dd HH:mm:ss');\n    const values = {\n      touser: openid,\n      template_id: 'RKlqOxxxhRROnxxxALvXo',\n      miniprogram: {\n        appid,\n        pagepath: `xxx`, // \u5c0f\u7a0b\u5e8f\u4e2d\u7684\u9875\u9762\n      },\n      data: {\n        first: {\n          value: '\u60a8\u6709\u4e00\u7b14\u65b0\u7684\u8ba2\u5355\uff0c\u8bf7\u53ca\u65f6\u5904\u7406',\n          color: '#173177',\n        },\n        keyword1: {\n          value: `No.${order_id}`,\n          color: '#173177',\n        },\n        keyword2: {\n          value: user_info,\n          color: '#173177',\n        },\n        keyword3: {\n          value: `${amount}\u5143`,\n          color: '#173177',\n        },\n        keyword4: {\n          value: '\u5fae\u4fe1\u652f\u4ed8',\n          color: '#173177',\n        },\n        keyword5: {\n          value: currentTime,\n          color: '#173177',\n        },\n        remark: {\n          value: '\u70b9\u51fb\u67e5\u770b\u8be6\u60c5...',\n          color: '#173177',\n        },\n      },\n    };\n    const res = await templateSend(values);\n    ctx.state.code = 0;\n    ctx.state.data = res;\n  } catch (err) {\n    ctx.state.code = -1;\n    throw new Error(err);\n  }\n}",lang:"js"}))))}}]);