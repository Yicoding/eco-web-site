(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[161],{FbfC:function(e,n,t){"use strict";t.r(n);var a=t("q1tI"),l=t.n(a),r=t("dEAq"),c=t("H1Ra");t("JjdP");n["default"]=e=>(l.a.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&r["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"markdown"},l.a.createElement("h1",{id:"\u5fae\u4fe1\u652f\u4ed8-\u5c0f\u7a0b\u5e8f\u652f\u4ed8"},l.a.createElement(r["AnchorLink"],{to:"#\u5fae\u4fe1\u652f\u4ed8-\u5c0f\u7a0b\u5e8f\u652f\u4ed8","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u5fae\u4fe1\u652f\u4ed8-\u5c0f\u7a0b\u5e8f\u652f\u4ed8"),l.a.createElement("h2",{id:"1\u5206\u7c7b-\u4e24\u79cd\u6a21\u5f0f"},l.a.createElement(r["AnchorLink"],{to:"#1\u5206\u7c7b-\u4e24\u79cd\u6a21\u5f0f","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"1.\u5206\u7c7b-\u4e24\u79cd\u6a21\u5f0f"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u5fae\u4fe1\u652f\u4ed8\u76ee\u524d\u63d0\u4f9b\u4e24\u79cd\u63a5\u5165\u65b9\u5f0f\uff1a",l.a.createElement("code",null,"\u76f4\u8fde\u6a21\u5f0f(\u666e\u901a\u5546\u6237\u6a21\u5f0f)"),"\u548c",l.a.createElement("code",null,"\u670d\u52a1\u5546\u6a21\u5f0f"))),l.a.createElement("h3",{id:"1\u76f4\u8fde\u6a21\u5f0f"},l.a.createElement(r["AnchorLink"],{to:"#1\u76f4\u8fde\u6a21\u5f0f","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"1\uff09\u76f4\u8fde\u6a21\u5f0f"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("p",null,"\u662f\u6307\u4f7f\u7528\u5fae\u4fe1\u652f\u4ed8\u6536\u94f6\u7684\u5546\u6237\uff0c\u4e00\u4e2a\u8d26\u6237\u670d\u52a1\u4e8e\u4e00\u4e2a\u5546\u6237")),l.a.createElement("li",null,l.a.createElement("p",null,"\u4fe1\u606f\u3001\u8d44\u91d1\u6d41\uff1a\u5fae\u4fe1\u652f\u4ed8\u2014>\u76f4\u8fde\u5546\u6237")),l.a.createElement("li",null,l.a.createElement("p",null,"\u76f4\u8fde\u6a21\u5f0f\uff0c\u5546\u6237\u81ea\u884c\u7533\u8bf7\u5165\u9a7b\u5fae\u4fe1\u652f\u4ed8\uff0c\u65e0\u9700\u670d\u52a1\u5546\u534f\u52a9\u3002\uff08\u5546\u6237\u5e73\u53f0\u7533\u8bf7\uff09\u6210\u4e3a\u666e\u901a\u5546\u6237"))),l.a.createElement("h3",{id:"2\u670d\u52a1\u5546\u6a21\u5f0f"},l.a.createElement(r["AnchorLink"],{to:"#2\u670d\u52a1\u5546\u6a21\u5f0f","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"2\uff09\u670d\u52a1\u5546\u6a21\u5f0f"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("p",null,"\u5177\u6709",l.a.createElement("code",null,"\u6280\u672f\u5f00\u53d1\u80fd\u529b"),"\u4e14\u80fd\u591f\u4e3a\u666e\u901a\u5546\u6237",l.a.createElement("code",null,"\u63d0\u4f9b\u5fae\u4fe1\u652f\u4ed8"),"\u6280\u672f\u5f00\u53d1\u3001\u8425\u9500\u65b9\u6848\u7684\u7b2c\u4e09\u65b9\u5f00\u53d1\u8005"),l.a.createElement("ul",null,l.a.createElement("li",null,"1.\u670d\u52a1\u5546\u81ea\u8eab\u65e0\u6cd5\u4f5c\u4e3a\u4e00\u4e2a\u666e\u901a\u5546\u6237\u76f4\u63a5\u53d1\u8d77\u4ea4\u6613\uff0c\u5176\u53d1\u8d77\u4ea4\u6613\u5fc5\u987b\u4f20\u5165\u76f8\u5173",l.a.createElement("code",null,"\u7279\u7ea6\u5546\u6237"),"\u5546\u6237\u53f7\u7684\u53c2\u6570\u4fe1\u606f"),l.a.createElement("li",null,"2.\u670d\u52a1\u5546\u7684\u5546\u6237\u53f7\u65e0\u7ed3\u7b97\u529f\u80fd\uff0c\u53d1\u8d77\u4ea4\u6613\u65f6\uff0c\u5bf9\u5e94\u4ea4\u6613\u6b3e\u76f4\u63a5\u8fdb\u5165\u5176\u7279\u7ea6\u5546\u6237\u7684\u5546\u6237\u53f7\u8d26\u6237"))),l.a.createElement("li",null,l.a.createElement("p",null,"\u670d\u52a1\u5546\u6a21\u5f0f\uff0c\u5546\u6237\u7533\u8bf7\u6210\u4e3a\u5fae\u4fe1\u652f\u4ed8\u670d\u52a1\u5546\uff0c\u670d\u52a1\u5546\u81ea\u8eab\u65e0\u6cd5\u4f5c\u4e3a\u4e00\u4e2a\u666e\u901a\u5546\u6237\u76f4\u63a5\u53d1\u8d77\u4ea4\u6613\uff0c\u5176\u53d1\u8d77\u4ea4\u6613\u5fc5\u987b\u4f20\u5165\u76f8\u5173\u7279\u7ea6\u5546\u6237\u5546\u6237\u53f7\u7684\u53c2\u6570\u4fe1\u606f\u3002\uff08\u670d\u52a1\u5546\u5e73\u53f0\u7533\u8bf7\uff09\u6210\u4e3a\u666e\u901a\u670d\u52a1\u5546"))),l.a.createElement("h2",{id:"2\u76f4\u8fde\u6a21\u5f0f"},l.a.createElement(r["AnchorLink"],{to:"#2\u76f4\u8fde\u6a21\u5f0f","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"2.\u76f4\u8fde\u6a21\u5f0f"),l.a.createElement("h3",{id:"1jsapi-\u4e0b\u5355\u670d\u52a1\u7aef\u63d0\u4f9b\u63a5\u53e3\u7ed9\u524d\u7aef"},l.a.createElement(r["AnchorLink"],{to:"#1jsapi-\u4e0b\u5355\u670d\u52a1\u7aef\u63d0\u4f9b\u63a5\u53e3\u7ed9\u524d\u7aef","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"1\uff09JSAPI \u4e0b\u5355\uff08\u670d\u52a1\u7aef\u63d0\u4f9b\u63a5\u53e3\u7ed9\u524d\u7aef\uff09"),l.a.createElement("p",null,l.a.createElement("strong",null,"1.\u53c2\u6570")),l.a.createElement("table",null,l.a.createElement("thead",null,l.a.createElement("tr",null,l.a.createElement("th",{align:"left"},"\u53c2\u6570"),l.a.createElement("th",{align:"left"},"\u8bf4\u660e"))),l.a.createElement("tbody",null,l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"appid")),l.a.createElement("td",{align:"left"},"\u5c0f\u7a0b\u5e8f\u7684\u5e94\u7528 ID(\u5fae\u4fe1\u652f\u4ed8\u7684\u914d\u7f6e\u9879)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"mchid")),l.a.createElement("td",{align:"left"},"\u5546\u5bb6\u7684\u5546\u6237\u53f7\uff0c\u5728\u7533\u8bf7\u6210\u4e3a\u5546\u6237\u65f6\u5fae\u4fe1\u751f\u6210\u7684\u5546\u6237\u53f7(\u5fae\u4fe1\u652f\u4ed8\u7684\u914d\u7f6e\u9879)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"description")),l.a.createElement("td",{align:"left"},"\u5546\u54c1\u63cf\u8ff0(\u7531\u5ba2\u6237\u7aef\u4f20\u5165)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"out_trade_no")),l.a.createElement("td",{align:"left"},"\u5546\u6237\u7cfb\u7edf\u5185\u90e8\u8ba2\u5355\u53f7(\u7531\u670d\u52a1\u7aef\u751f\u6210)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"notify_url")),l.a.createElement("td",{align:"left"},"\u5fae\u4fe1\u652f\u4ed8\u7ed3\u679c\u901a\u77e5\u7684\u56de\u8c03\u5730\u5740(\u9700\u8981\u670d\u52a1\u7aef\u914d\u7f6e\u4e00\u4e2a\u53ef\u4ee5\u63a5\u6536\u56de\u8c03\u7684\u63a5\u53e3)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"amount")),l.a.createElement("td",{align:"left"},"\u8ba2\u5355\u91d1\u989d\u4fe1\u606f(\u7531\u5ba2\u6237\u7aef\u4f20\u5165)\uff0c\u5305\u62ec\u8ba2\u5355\u91d1\u989d(\u4ee5",l.a.createElement("code",null,"\u5206"),"\u4e3a\u5355\u4f4d)\u548c\u8d27\u5e01\u7c7b\u578b(",l.a.createElement("code",null,"CNY"),"\uff1a\u4eba\u6c11\u5e01)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"payer")),l.a.createElement("td",{align:"left"},"\u652f\u4ed8\u8005\u4fe1\u606f(\u7531\u5ba2\u6237\u7aef\u4f20\u5165)\uff0c\u9700\u8981\u7528\u6237\u5728\u5c0f\u7a0b\u5e8f\u4e2d\u7684 ",l.a.createElement("code",null,"openid"))))),l.a.createElement("p",null,l.a.createElement("strong",null,"2.\u751f\u6210\u7b7e\u540d")),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("p",null,"1.\u683c\u5f0f\uff1a"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u7b7e\u540d\u4e32\u4e00\u5171\u6709",l.a.createElement("code",null,"\u4e94\u884c"),"\uff0c\u6bcf\u4e00\u884c\u4e3a\u4e00\u4e2a\u53c2\u6570\u3002\u884c\u5c3e\u4ee5 ",l.a.createElement("code",null,"\\n"),"\uff08\u6362\u884c\u7b26\uff0cASCII \u7f16\u7801\u503c\u4e3a 0x0A\uff09",l.a.createElement("code",null,"\u7ed3\u675f"),"\uff0c\u5305\u62ec\u6700\u540e\u4e00\u884c\u3002\u5982\u679c\u53c2\u6570\u672c\u8eab\u4ee5",l.a.createElement("code",null,"\\n \u7ed3\u675f"),"\uff0c\u4e5f\u9700\u8981",l.a.createElement("code",null,"\u9644\u52a0"),"\u4e00\u4e2a",l.a.createElement("code",null,"\\n"))),l.a.createElement(c["a"],{code:"HTTP\u8bf7\u6c42\u65b9\u6cd5\\n\nURL\\n\n\u8bf7\u6c42\u65f6\u95f4\u6233\\n\n\u8bf7\u6c42\u968f\u673a\u4e32\\n\n\u8bf7\u6c42\u62a5\u6587\u4e3b\u4f53\\n",lang:"js"})),l.a.createElement("li",null,l.a.createElement("p",null,"2.\u5c01\u88c5\u7b7e\u540d\u65b9\u6cd5"))),l.a.createElement(c["a"],{code:"const fs = require('fs');\n\nfunction getSign(content, hash = 'SHA256withRSA') {\n  const pem = fs.readFileSync('./server/apiclient_key.pem'); // \u5fae\u4fe1\u652f\u4ed8\u5e73\u53f0\u8bc1\u4e66\n  const prvkeypem = pem.toString('ascii'); // \u751f\u6210\u79c1\u94a5\n\n  // \u521b\u5efa Signature \u5bf9\u8c61\n  const signature = new KJUR.crypto.Signature({\n    alg: hash,\n    //!\u8fd9\u91cc\u6307\u5b9a \u79c1\u94a5 pem!\n    prvkeypem,\n  });\n  signature.updateString(content);\n  const signData = signature.sign();\n  // \u5c06\u5185\u5bb9\u8f6c\u6210base64\n  return hextob64(signData);\n}",lang:"js"}),l.a.createElement("ul",null,l.a.createElement("li",null,"3.\u8ba1\u7b97\u7b7e\u540d\u503c")),l.a.createElement(c["a"],{code:"const timestamp = `${parseInt(new Date().getTime() / 1000)}`; // \u65f6\u95f4\u6233\nconst nonce_str = Math.random().toString(36).substr(2, 15); // \u968f\u673a\u5b57\u7b26\u4e32\uff0c\u957f\u5ea6\u4e3a32\u4e2a\u5b57\u7b26\u4ee5\u4e0b\n\nconst values = {\n  appid,\n  mchid,\n  description,\n  out_trade_no,\n  notify_url,\n  amount: {\n    total,\n    currency: 'CNY',\n  },\n  payer: { openid },\n};\nconst signature = getSign(\n  `POST\\n/v3/pay/transactions/jsapi\\n${timestamp}\\n${nonce_str}\\n${JSON.stringify(\n    values,\n  )}\\n`,\n);",lang:"js"}),l.a.createElement("ul",null,l.a.createElement("li",null,"4.\u8bbe\u7f6e HTTP \u5934")),l.a.createElement("blockquote",null,l.a.createElement("p",null,"Authorization: \u8ba4\u8bc1\u7c7b\u578b \u7b7e\u540d\u4fe1\u606f"),l.a.createElement("blockquote",null,l.a.createElement("p",null,"\u8ba4\u8bc1\u7c7b\u578b: WECHATPAY2-SHA256-RSA2048"))),l.a.createElement(c["a"],{code:'const Authorization = `WECHATPAY2-SHA256-RSA2048 mchid="${mchid}",serial_no="${serial_no}",nonce_str="${nonce_str}",timestamp="${timestamp}",signature="${signature}"`;\nconst url = \'https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi\';\n\nconst res = await axios.post(url, values, {\n  headers: { Authorization },\n});',lang:"js"}),l.a.createElement("ul",null,l.a.createElement("li",null,"5.\u7b7e\u540d\u9a8c\u8bc1")),l.a.createElement(c["a"],{code:"\u5e94\u7b54\u65f6\u95f4\u6233\\n\n\u5e94\u7b54\u968f\u673a\u4e32\\n\n\u5e94\u7b54\u62a5\u6587\u4e3b\u4f53\\n",lang:"js"}),l.a.createElement(c["a"],{code:"const newsignature = getSign(\n  `${appid}\\n${timestamp}\\n${nonce_str}\\nprepay_id=${res.data.prepay_id}\\n`,\n);",lang:"js"}),l.a.createElement("ul",null,l.a.createElement("li",null,"6.\u8fd4\u56de\u5ba2\u6237\u7aef\u652f\u4ed8\u65f6\u9700\u8981\u7684\u53c2\u6570")),l.a.createElement(c["a"],{code:"ctx.state.data = {\n  prepay_id: res.data.prepay_id,\n  timeStamp: timestamp,\n  nonceStr: nonce_str,\n  paySign: newsignature,\n};",lang:"js"}),l.a.createElement("h3",{id:"2\u5c0f\u7a0b\u5e8f\u53d1\u8d77\u5fae\u4fe1\u652f\u4ed8"},l.a.createElement(r["AnchorLink"],{to:"#2\u5c0f\u7a0b\u5e8f\u53d1\u8d77\u5fae\u4fe1\u652f\u4ed8","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"2\uff09\u5c0f\u7a0b\u5e8f\u53d1\u8d77\u5fae\u4fe1\u652f\u4ed8"),l.a.createElement(c["a"],{code:"// \u5148\u8c03\u7528\u670d\u52a1\u7aef\u4e0b\u5355\u63a5\u53e3\uff0c\u8fd4\u56de\u652f\u4ed8\u6240\u9700\u7684\u53c2\u6570\u540e\uff0c\u518d\u53d1\u8d77\u5fae\u4fe1\u652f\u4ed8\nwx.requestPayment({\n  timeStamp: data.timeStamp,\n  nonceStr: data.nonceStr,\n  package: 'prepay_id=' + data.prepay_id,\n  signType: 'RSA',\n  paySign: data.paySign,\n  success: (res) => {\n    console.log('success', res);\n    resolve(res);\n  },\n  fail: (err) => {\n    console.log('fail', err);\n    reject(err);\n  },\n  complete: (e) => {\n    console.log('complete', e);\n  },\n});",lang:"js"}),l.a.createElement("h2",{id:"3\u670d\u52a1\u5546\u6a21\u5f0f"},l.a.createElement(r["AnchorLink"],{to:"#3\u670d\u52a1\u5546\u6a21\u5f0f","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"3.\u670d\u52a1\u5546\u6a21\u5f0f"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("p",null,"\u670d\u52a1\u5546\u6a21\u5f0f\u53ef\u4ee5\u9009\u62e9",l.a.createElement("code",null,"\u7279\u7ea6\u5546\u6237\u8fdb\u4ef6"),"\u548c\u884c\u4e1a\u65b9\u6848\u4e2d\u7684",l.a.createElement("code",null,"\u7535\u5546\u6536\u4ed8\u901a"),"\u65b9\u6848")),l.a.createElement("li",null,l.a.createElement("p",null,"\u533a\u522b\uff1a"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u7279\u7ea6\u5546\u6237\u8fdb\u4ef6\u7684\u5546\u6237\uff0c\u5206\u8d26\u65f6\uff0c\u9700\u8981\u7279\u7ea6\u5546\u6237\u7b7e\u7f72\u534f\u8bae\uff0c\u7279\u7ea6\u5546\u6237\u987b\u914d\u7f6e\u5141\u8bb8\u670d\u52a1\u5546\u5206\u8d26\u7684\u6700\u5927\u6bd4\u4f8b\uff0c"),l.a.createElement("li",null,"\u7535\u5546\u6536\u4ed8\u901a\uff0c\u670d\u52a1\u5546\u53ef\u4ee5\u81ea\u884c\u8bbe\u7f6e\u5206\u8d26\u6bd4\u4f8b\uff0c\u65e0\u9700\u5546\u6237\u786e\u8ba4"),l.a.createElement("li",null,"\u5206\u8d26\u6bd4\u4f8b\u6700\u9ad8 30%")))),l.a.createElement("h3",{id:"1\u4e8c\u7ea7\u5546\u6237\u8fdb\u4ef6"},l.a.createElement(r["AnchorLink"],{to:"#1\u4e8c\u7ea7\u5546\u6237\u8fdb\u4ef6","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"1\uff09\u4e8c\u7ea7\u5546\u6237\u8fdb\u4ef6"),l.a.createElement("p",null,l.a.createElement("strong",null,"1.\u5ba2\u6237\u7aef\u6536\u96c6\u5546\u6237\u6240\u9700\u4fe1\u606f\uff0c\u4e0a\u9001\u670d\u52a1\u7aef")),l.a.createElement("p",null,l.a.createElement("strong",null,"2.\u5e73\u53f0\u8bc1\u4e66\u56de\u8c03\u62a5\u6587\u89e3\u5bc6")),l.a.createElement(c["a"],{code:"/**\n * \u89e3\u5bc6\n *\n * @param {string} cipherText \u6587\u672c\n * @param {string} key \u5e73\u53f0\u5bc6\u94a5\n * @param {string} nonce \u504f\u79fb\u91cf\uff08nonce\uff09\n * @param {string} associated_data associated_data\n */\nfunction decryptAes(key, cipherText, nonce, associated_data) {\n  // console.log('key', key, cipherText, nonce, associated_data)\n  const result = AesGcm.decrypt(nonce, key, cipherText, associated_data);\n  // console.log('result', result);\n  return result;\n}",lang:"js"}),l.a.createElement("p",null,l.a.createElement("strong",null,"3.\u83b7\u53d6\u5e73\u53f0\u8bc1\u4e66")),l.a.createElement(c["a"],{code:'function getCertificates() {\n  return new Promise(async (resolve, reject) => {\n    try {\n      const {\n        mchid_service, // \u5fae\u4fe1\u5546\u6237\u53f7-\u670d\u52a1\u5546\n        serial_no_service, // \u5546\u6237API\u8bc1\u4e66\n        mchkey, // \u5fae\u4fe1\u5546\u6237\u7684key 32\u4f4d\n      } = config;\n\n      const nonce_str = Math.random().toString(36).substr(2, 15);\n      const timestamp = `${parseInt(new Date().getTime() / 1000)}`;\n      const signature = getSignServer(\n        `GET\\n/v3/certificates\\n${timestamp}\\n${nonce_str}\\n\\n`,\n      );\n\n      const Authorization = `WECHATPAY2-SHA256-RSA2048 mchid="${mchid_service}",serial_no="${serial_no_service}",nonce_str="${nonce_str}",timestamp="${timestamp}",signature="${signature}"`;\n\n      const url = \'https://api.mch.weixin.qq.com/v3/certificates\';\n\n      const res = await axios.get(url, {\n        headers: {\n          Authorization,\n          Accept: \'application/json\',\n        },\n      });\n      const {\n        encrypt_certificate: { ciphertext, nonce, associated_data }, // \u8bc1\u4e66\u5185\u5bb9\n        serial_no, // \u5e8f\u5217\u53f7\n      } = res.data.data[0];\n      const publicKey = decryptAes(mchkey, ciphertext, nonce, associated_data);\n      resolve({\n        serial_no,\n        publicKey,\n      });\n    } catch (err) {\n      reject(err);\n    }\n  });\n}',lang:"js"}),l.a.createElement("p",null,l.a.createElement("strong",null,"3.\u56fe\u7247\u4e0a\u4f20 API")),l.a.createElement("ul",null,l.a.createElement("li",null,"\u83b7\u53d6\u56fe\u7247 MediaID")),l.a.createElement(c["a"],{code:"const request = require('superagent');\nconst WxPay = require('wechatpay-node-v3');\nconst crypto = require('crypto');\n\n/*\n * @pic_buffer: \u56fe\u7247\u7684buffer\n */\nfunction mediaUploadBuffer(pic_buffer) {\n  return new Promise(async (resolve, reject) => {\n    try {\n      const {\n        appid, // \u5c0f\u7a0b\u5e8fid\n        mchid_service, // \u5fae\u4fe1\u5546\u6237\u53f7-\u670d\u52a1\u5546\n        serial_no_service, // \u5546\u6237API\u8bc1\u4e66\n      } = config;\n      const pay = new WxPay({\n        appid,\n        mchid: mchid_service,\n        serial_no: serial_no_service,\n        publicKey: fs.readFileSync('./server/apiclient_cert_server.pem'), // \u516c\u94a5\n        privateKey: fs.readFileSync('./server/apiclient_key_server.pem'), // \u79d8\u94a5\n      });\n      // meta\u4fe1\u606f\n      const fileinfo = {\n        filename: '',\n        sha256: '',\n      };\n      const sign = crypto.createHash('sha256');\n      sign.update(pic_buffer);\n      fileinfo.filename = 'filea.png';\n      fileinfo.sha256 = sign.digest('hex');\n      const timestamp = `${parseInt(new Date().getTime() / 1000)}`;\n      const nonce_str = Math.random().toString(36).substr(2, 15);\n      const url = '/v3/merchant/media/upload';\n\n      const signature = pay.getSignature(\n        'POST',\n        nonce_str,\n        timestamp,\n        url,\n        fileinfo,\n      );\n      const authorization = pay.getAuthorization(\n        nonce_str,\n        timestamp,\n        signature,\n      );\n      const result = await request\n        .post('https://api.mch.weixin.qq.com/v3/merchant/media/upload')\n        .set({\n          Accept: 'application/json',\n          'Content-Type': 'multipart/form-data;boundary=boundary',\n          'User-Agent': '127.0.0.1',\n          Authorization: authorization,\n          Charsert: 'UTF-8',\n        })\n        .attach('file', pic_buffer, {\n          filename: 'filea.png',\n          contentType: 'image/png',\n        })\n        .field('meta', JSON.stringify(fileinfo));\n\n      // console.log('result', result);\n      if (result.status === 200 && result.text) {\n        const { media_id } = JSON.parse(result.text);\n        resolve(media_id);\n      } else {\n        ctx.state.data = result;\n        reject(result);\n      }\n    } catch (err) {\n      reject(err);\n    }\n  });\n}",lang:"js"}),l.a.createElement("p",null,l.a.createElement("strong",null,"4.\u5e73\u53f0\u8bc1\u4e66\u52a0\u5bc6")),l.a.createElement(c["a"],{code:"/*\n * @data: \u9700\u8981\u52a0\u5bc6\u7684\u4fe1\u606f\n * @publicKey: \u9700\u8981\u52a0\u5bc6\u7684\u4fe1\u606f\n */\nfunction encryptParams(data, publicKey) {\n  const encodeData = crypto\n    .publicEncrypt(\n      {\n        key: publicKey,\n        padding: crypto.constants.RSA_PKCS1_OAEP_PADDING,\n      },\n      Buffer.from(data),\n    )\n    .toString('base64');\n  // console.log(\"encode: \", encodeData)\n  return encodeData;\n}",lang:"js"}),l.a.createElement("p",null,l.a.createElement("strong",null,"5.\u5546\u6237\u8fdb\u4ef6")),l.a.createElement(c["a"],{code:'const {\n  mchid_service, // \u5fae\u4fe1\u5546\u6237\u53f7-\u670d\u52a1\u5546\n  serial_no_service, // \u5546\u6237API\u8bc1\u4e66\n} = gouxuanStore;\nconst nonce_str = Math.random().toString(36).substr(2, 15);\nconst timestamp = `${parseInt(new Date().getTime() / 1000)}`;\n\nconst url = \'https://api.mch.weixin.qq.com/v3/ecommerce/applyments/\';\nconst signature = getSignServer(\n  `POST\\n/v3/ecommerce/applyments/\\n${timestamp}\\n${nonce_str}\\n${JSON.stringify(\n    values,\n  )}\\n`,\n);\n\nconst Authorization = `WECHATPAY2-SHA256-RSA2048 mchid="${mchid_service}",serial_no="${serial_no_service}",nonce_str="${nonce_str}",timestamp="${timestamp}",signature="${signature}"`;\n\n// Wechatpay_serial_no: getCertificates\u65b9\u6cd5\u8fd4\u56de\u7684serial_no(\u5e8f\u5217\u53f7)\nconst res = await axios.post(url, values, {\n  headers: {\n    Authorization,\n    Accept: \'application/json\',\n    \'Wechatpay-Serial\': Wechatpay_serial_no,\n  },\n});',lang:"js"}),l.a.createElement("h3",{id:"2\u670d\u52a1\u5546\u5e2e\u5ba2\u6237\u53d1\u8d77\u652f\u4ed8\u4ed8\u6b3e\u5230\u5546\u5bb6\u5546\u6237\u53f7"},l.a.createElement(r["AnchorLink"],{to:"#2\u670d\u52a1\u5546\u5e2e\u5ba2\u6237\u53d1\u8d77\u652f\u4ed8\u4ed8\u6b3e\u5230\u5546\u5bb6\u5546\u6237\u53f7","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"2\uff09\u670d\u52a1\u5546\u5e2e\u5ba2\u6237\u53d1\u8d77\u652f\u4ed8\u4ed8\u6b3e\u5230\u5546\u5bb6\u5546\u6237\u53f7"),l.a.createElement("table",null,l.a.createElement("thead",null,l.a.createElement("tr",null,l.a.createElement("th",{align:"left"},"\u53c2\u6570"),l.a.createElement("th",{align:"left"},"\u8bf4\u660e"))),l.a.createElement("tbody",null,l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"sp_appid")),l.a.createElement("td",{align:"left"},"\u5c0f\u7a0b\u5e8f\u5ba2\u6237\u7aef\u7684\u5e94\u7528 ID(\u5fae\u4fe1\u652f\u4ed8\u7684\u914d\u7f6e\u9879)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"sp_mchid")),l.a.createElement("td",{align:"left"},"\u5fae\u4fe1\u5546\u6237\u53f7-\u670d\u52a1\u5546(\u5fae\u4fe1\u652f\u4ed8\u7684\u914d\u7f6e\u9879)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"sub_mchid")),l.a.createElement("td",{align:"left"},"\u4e8c\u7ea7\u5546\u6237\u7684\u5546\u6237\u53f7")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"description")),l.a.createElement("td",{align:"left"},"\u5546\u54c1\u63cf\u8ff0(\u7531\u5ba2\u6237\u7aef\u4f20\u5165)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"out_trade_no")),l.a.createElement("td",{align:"left"},"\u5546\u6237\u7cfb\u7edf\u5185\u90e8\u8ba2\u5355\u53f7(\u7531\u670d\u52a1\u7aef\u751f\u6210)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"notify_url")),l.a.createElement("td",{align:"left"},"\u5fae\u4fe1\u652f\u4ed8\u7ed3\u679c\u901a\u77e5\u7684\u56de\u8c03\u5730\u5740(\u9700\u8981\u670d\u52a1\u7aef\u914d\u7f6e\u4e00\u4e2a\u53ef\u4ee5\u63a5\u6536\u56de\u8c03\u7684\u63a5\u53e3)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"settle_info")),l.a.createElement("td",{align:"left"},"\u7ed3\u7b97\u4fe1\u606f(profit_sharing: \u662f\u5426\u6307\u5b9a\u5206\u8d26)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"amount")),l.a.createElement("td",{align:"left"},"\u8ba2\u5355\u91d1\u989d\u4fe1\u606f(\u7531\u5ba2\u6237\u7aef\u4f20\u5165)\uff0c\u5305\u62ec\u8ba2\u5355\u91d1\u989d(\u4ee5",l.a.createElement("code",null,"\u5206"),"\u4e3a\u5355\u4f4d)\u548c\u8d27\u5e01\u7c7b\u578b(",l.a.createElement("code",null,"CNY"),"\uff1a\u4eba\u6c11\u5e01)")),l.a.createElement("tr",null,l.a.createElement("td",{align:"left"},l.a.createElement("code",null,"payer")),l.a.createElement("td",{align:"left"},"\u652f\u4ed8\u8005\u4fe1\u606f(\u7531\u5ba2\u6237\u7aef\u4f20\u5165)\uff0csp_openid \u9700\u8981\u7528\u6237\u5728\u5c0f\u7a0b\u5e8f\u4e2d\u7684 ",l.a.createElement("code",null,"openid"))))),l.a.createElement(c["a"],{code:"// \u670d\u52a1\u5546\u7b7e\u540d\nfunction getSignServer(content, hash = 'SHA256withRSA') {\n  var pem = fs.readFileSync('./server/apiclient_key_server.pem');\n  var prvkeypem = pem.toString('ascii');\n\n  // \u521b\u5efa Signature \u5bf9\u8c61\n  const signature = new KJUR.crypto.Signature({\n    alg: hash,\n    //!\u8fd9\u91cc\u6307\u5b9a \u79c1\u94a5 pem!\n    prvkeypem,\n  });\n  signature.updateString(content);\n  const signData = signature.sign();\n  // \u5c06\u5185\u5bb9\u8f6c\u6210base64\n  return hextob64(signData);\n}\n\n// \u670d\u52a1\u5546\u5e2e\u5ba2\u6237\u53d1\u8d77\u652f\u4ed8\u4ed8\u6b3e\u5230\u5546\u5bb6\u5546\u6237\u53f7\nasync function wxapiServer(ctx) {\n  try {\n    const {\n      total,\n      openid,\n      description = '\u5546\u54c1',\n      sub_mchid,\n      out_trade_no,\n    } = ctx.request.body;\n    const {\n      mchid_service,\n      notify_url_server,\n      serial_no_service,\n      appid: c_appid,\n    } = config;\n    const nonce_str = Math.random().toString(36).substr(2, 15);\n    const timestamp = `${parseInt(new Date().getTime() / 1000)}`;\n\n    const values = {\n      sp_appid: c_appid,\n      sp_mchid: mchid_service,\n      sub_mchid,\n      description,\n      out_trade_no,\n      notify_url: notify_url_server,\n      settle_info: {\n        profit_sharing: true,\n      },\n      amount: {\n        total,\n        currency: 'CNY',\n      },\n      payer: { sp_openid: openid },\n    };\n\n    const url =\n      'https://api.mch.weixin.qq.com/v3/pay/partner/transactions/jsapi';\n    const signature = getSignServer(\n      `POST\\n/v3/pay/partner/transactions/jsapi\\n${timestamp}\\n${nonce_str}\\n${JSON.stringify(\n        values,\n      )}\\n`,\n    );\n\n    const Authorization = `WECHATPAY2-SHA256-RSA2048 mchid=\"${mchid_service}\",serial_no=\"${serial_no_service}\",nonce_str=\"${nonce_str}\",timestamp=\"${timestamp}\",signature=\"${signature}\"`;\n\n    const res = await wxapiRequest(url, values, {\n      headers: {\n        Authorization,\n        'Content-Type': 'application/json',\n        Accept: 'application/json',\n      },\n    });\n    const newsignature = getSignServer(\n      `${c_appid}\\n${timestamp}\\n${nonce_str}\\nprepay_id=${res.data.prepay_id}\\n`,\n    );\n    ctx.state.code = 0;\n    ctx.state.data = {\n      appId: c_appid,\n      prepay_id: res.data.prepay_id,\n      timeStamp: timestamp,\n      nonceStr: nonce_str,\n      paySign: newsignature,\n    };\n  } catch (err) {\n    ctx.state.code = -1;\n    throw new Error(err);\n  }\n}",lang:"js"}),l.a.createElement("h3",{id:"3\u5ba2\u6237\u7aef\u53d1\u8d77\u5fae\u4fe1\u652f\u4ed8"},l.a.createElement(r["AnchorLink"],{to:"#3\u5ba2\u6237\u7aef\u53d1\u8d77\u5fae\u4fe1\u652f\u4ed8","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"3\uff09\u5ba2\u6237\u7aef\u53d1\u8d77\u5fae\u4fe1\u652f\u4ed8"),l.a.createElement(c["a"],{code:"wx.requestPayment({\n  appId: data.appId,\n  timeStamp: data.timeStamp,\n  nonceStr: data.nonceStr,\n  package: 'prepay_id=' + data.prepay_id,\n  signType: 'RSA',\n  paySign: data.paySign,\n  success: (res) => {\n    console.log('success', res);\n    resolve(res);\n  },\n  fail: (err) => {\n    console.log('fail', err);\n    reject(err);\n  },\n  complete: (e) => {\n    console.log('complete', e);\n  },\n});",lang:"js"}))))},JjdP:function(e,n,t){"use strict";t.r(n),n["default"]={}},Zs1V:function(e){e.exports=JSON.parse("{}")}}]);